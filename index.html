<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Realtime Minimal Chat</title>
  <style>
    :root{--bg:#0f1720;--surface:#0b1220;--surface-2:#0f1726;--text:#e6eef8;--muted:#9aa6b2;--accent:#6b5cff;--accent-hover:#574be6;--shadow:0 12px 30px rgba(2,6,23,.6);--ring:0 0 0 4px rgba(107,92,255,.14)}
    [data-theme="light"]{--bg:#f6f7fb;--surface:#ffffff;--surface-2:#f3f5fb;--text:#0b1220;--muted:#6b7280;--accent:#5b21b6;--accent-hover:#46178f;--shadow:0 8px 24px rgba(16,24,40,.06);--ring:0 0 0 4px rgba(91,33,182,.08)}
    *{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;display:flex;flex-direction:column;background:var(--bg);color:var(--text);transition:background .2s,color .2s}
    .app{max-width:1000px;margin:0 auto;padding:18px;display:flex;flex-direction:column;min-height:100dvh;gap:14px}
    header.appbar{display:flex;align-items:center;justify-content:space-between}
    .brand h1{margin:0;font-size:1.2rem;color:var(--accent);letter-spacing:.2px}
    .brand p{margin:0;font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:8px;align-items:center}
    .btn{background:var(--surface);border:1px solid rgba(255,255,255,.04);padding:8px 10px;border-radius:10px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;box-shadow:var(--shadow)}
    .btn:focus{box-shadow:var(--ring)}

    .card{background:var(--surface);border-radius:16px;padding:14px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:12px;min-height:60dvh}
    .chat{overflow:auto;padding:8px;border-radius:12px;background:transparent;border:1px solid rgba(255,255,255,.03);min-height:280px;max-height:65dvh;display:flex;flex-direction:column;gap:10px;scroll-behavior:smooth}

    .msg{display:grid;grid-template-columns:48px 1fr auto;gap:12px;align-items:start;background:transparent;padding:8px;border-radius:12px;animation:fadeIn .18s ease}
    .msg[data-own="true"]{background:linear-gradient(180deg,rgba(255,255,255,.02),transparent)}
    .avatar{width:48px;height:48px;border-radius:999px;display:grid;place-items:center;font-weight:700;color:#fff;flex-shrink:0}
    .meta{font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center}
    .sender{font-weight:600}
    .text{white-space:pre-wrap;word-break:break-word;margin-top:6px}
    .actions{display:flex;gap:6px;flex-direction:column;align-items:center}
    .pill{background:var(--surface-2);border-radius:999px;padding:6px 8px;border:1px solid rgba(255,255,255,.04);cursor:pointer;font-size:13px}
    .reply-preview{font-size:12px;color:var(--muted);border-left:3px solid var(--accent);padding-left:8px;border-radius:6px;margin-bottom:6px}

    .composer{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:end}
    textarea.text-input{width:100%;min-height:56px;max-height:160px;padding:10px;border-radius:12px;border:1px solid transparent;background:var(--surface-2);color:var(--text);resize:vertical;outline:none}
    textarea.text-input:focus{box-shadow:var(--ring);border-color:rgba(255,255,255,.04)}
    .send{background:var(--accent);color:#fff;padding:12px 16px;border-radius:12px;border:none;cursor:pointer;font-weight:600}
    .send:disabled{opacity:.6;cursor:not-allowed}

    .reply-bar{display:none;align-items:center;gap:8px}
    .reply-bar.open{display:flex}

    footer{padding:10px 4px;text-align:center;color:var(--muted);font-size:13px}

    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

    /* Responsive tweaks */
    @media (max-width:640px){.msg{grid-template-columns:40px 1fr auto}.avatar{width:40px;height:40px}.brand h1{font-size:1rem}.app{padding:12px}}
  </style>
</head>
<body>
  <div class="app">
    <header class="appbar" role="banner">
      <div class="brand" aria-label="App title">
        <div>
          <h1>Minimal Realtime Chat</h1>
          <p>Realtime ‚Ä¢ replies ‚Ä¢ edits ‚Ä¢ reactions ‚Ä¢ light/dark</p>
        </div>
      </div>
      <div class="actions">
        <button id="theme-toggle" class="btn" aria-pressed="true" title="Toggle theme"><span id="theme-icon">üåô</span><span id="theme-label">Dark</span></button>
      </div>
    </header>

    <main class="card" role="main">
      <div id="chat-area" class="chat" aria-live="polite" aria-busy="false"></div>

      <div id="reply-bar" class="reply-bar" role="status">
        <span class="reply-chip">Replying to <strong id="replying-to-sender"></strong>: <span id="replying-to-text"></span></span>
        <button id="cancel-reply" class="btn" aria-label="Cancel reply">Cancel</button>
      </div>

      <form id="composer" class="composer" role="form" aria-label="Send a message" onsubmit="return false;">
        <textarea id="message-input" class="text-input" placeholder="Type a message‚Ä¶ (Shift+Enter for newline)" aria-label="Message input"></textarea>
        <div style="display:flex;flex-direction:column;gap:8px;align-items:stretch;">
          <button id="send-btn" class="send" disabled aria-label="Send message">Send</button>
        </div>
      </form>
    </main>

    <footer>made with ‚ù§Ô∏è‚òïÔ∏è</footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module">
    // ---------- CONFIG (replace if you want) ----------
    const SUPABASE_URL = 'https://fzjkpppzwiuozvszbbdl.supabase.co';
    // You provided this anon key; you can replace it with an env-based key if hosting securely.
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ6amtwcHB6d2l1b3p2c3piYmRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzODEwOTAsImV4cCI6MjA3MTk1NzA5MH0.32p6IZZYDIhd1RtPX8NgOv-kPjI-YBl5wCX5ajNnarg';

    const { createClient } = supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

    // ---------- DOM Refs ----------
    const $ = (s) => document.querySelector(s);
    const chatArea = $('#chat-area');
    const messageInput = $('#message-input');
    const sendBtn = $('#send-btn');
    const replyBar = $('#reply-bar');
    const replyToSender = $('#replying-to-sender');
    const replyToText = $('#replying-to-text');
    const cancelReplyBtn = $('#cancel-reply');
    const themeToggle = $('#theme-toggle');
    const themeIcon = $('#theme-icon');
    const themeLabel = $('#theme-label');

    // ---------- THEME ----------
    const THEME_KEY = 'pref-theme';
    function applyTheme(t){document.documentElement.setAttribute('data-theme', t);const dark = t==='dark';themeToggle.setAttribute('aria-pressed', String(dark));themeIcon.textContent = dark? 'üåô':'‚òÄÔ∏è';themeLabel.textContent = dark? 'Dark':'Light';try{localStorage.setItem(THEME_KEY,t)}catch{} }
    function getSystemTheme(){return window.matchMedia('(prefers-color-scheme: light)').matches? 'light':'dark'}
    (function initTheme(){let t='dark';try{t = localStorage.getItem(THEME_KEY) || getSystemTheme()}catch{}applyTheme(t)})();
    themeToggle.addEventListener('click', ()=> applyTheme(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark'));

    // ---------- USERNAME ----------
    const NAME_KEY = 'username';
    let currentUsername = '';
    function checkUsername(){try{currentUsername = localStorage.getItem(NAME_KEY) || '';}catch{}
      if(!currentUsername){currentUsername = prompt('Enter a username:') || 'Anonymous';try{localStorage.setItem(NAME_KEY,currentUsername)}catch{}}
    }
    checkUsername();

    // ---------- UTIL ----------
    const hashColor = (str)=>{let h=0;for(let i=0;i<str.length;i++)h=(h*31+str.charCodeAt(i))>>>0;return `hsl(${h%360} 68% 45%)`}
    const initials = (name)=> (name||'?').replace(/[_\-]+/g,' ').split(' ').filter(Boolean).slice(0,2).map(s=>s[0]?.toUpperCase()).join('')||'?';
    const fmtTime = (t)=> t? new Date(t).toLocaleString([], { hour:'2-digit', minute:'2-digit', day:'2-digit', month:'short' }): '';
    const scrollToBottom = ()=> {chatArea.scrollTop = chatArea.scrollHeight;};

    // ---------- REPLY STATE ----------
    let replyingToMessageId = null;
    function openReplyBar(username, text){replyToSender.textContent = username||'Unknown';replyToText.textContent = (text||'').slice(0,80);replyBar.classList.add('open')}
    function cancelReply(){replyingToMessageId = null;replyBar.classList.remove('open')}
    cancelReplyBtn.addEventListener('click', cancelReply);

    // ---------- MESSAGE SENDING ----------
    messageInput.addEventListener('input', ()=> sendBtn.disabled = messageInput.value.trim().length===0);
    messageInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); } });

    async function sendMessage(){
      const text = messageInput.value.trim(); if(!text) return;
      const payload = { username: currentUsername, text, reply_to: replyingToMessageId, created_at: new Date().toISOString(), reactions: { thumbsUp: 0, thumbsDown: 0 } };
      const { error } = await sb.from('messages').insert(payload);
      if(error){console.error('send error',error);alert('Could not send message.')} else { messageInput.value=''; sendBtn.disabled=true; cancelReply(); }
    }
    sendBtn.addEventListener('click', sendMessage);

    // ---------- RENDERING ----------
    const messagesMap = new Map();
    function safeTextNode(str){const d = document.createTextNode(str||'');return d}

    function messageNode(m){
      const id = m.id; const username = m.username || 'Unknown'; const text = m.text || ''; const created_at = m.created_at;
      const wrapper = document.createElement('div'); wrapper.className='msg'; wrapper.dataset.id = id; wrapper.id = `msg-${id}`; wrapper.setAttribute('data-own', String(username===currentUsername));

      const av = document.createElement('div'); av.className='avatar'; av.style.background = hashColor(username); av.textContent = initials(username);

      const content = document.createElement('div');
      const meta = document.createElement('div'); meta.className='meta';
      const sender = document.createElement('span'); sender.className='sender'; sender.textContent = username;
      const time = document.createElement('span'); time.className='time'; time.textContent = fmtTime(created_at);
      meta.append(sender, time);
      content.appendChild(meta);

      if(m.reply_to){ const rp = document.createElement('div'); rp.className='reply-preview'; const original = messagesMap.get(m.reply_to); if(original){ const strong = document.createElement('strong'); strong.textContent = original.username || 'Unknown'; rp.appendChild(document.createTextNode('Replying to ')); rp.appendChild(strong); rp.appendChild(document.createTextNode(': "' + ((original.text||'').slice(0,80)) + '"')); } else { rp.textContent = 'Replying to an older message.' } content.appendChild(rp); }

      const textEl = document.createElement('div'); textEl.className='text'; textEl.appendChild(safeTextNode(text)); content.appendChild(textEl);

      // actions
      const acts = document.createElement('div'); acts.className='actions';

      // if own -> edit/delete
      if(username === currentUsername){
        const editBtn = document.createElement('button'); editBtn.className='pill'; editBtn.textContent='Edit';
        editBtn.onclick = ()=> openEdit(wrapper, m);
        const delBtn = document.createElement('button'); delBtn.className='pill'; delBtn.textContent='Delete';
        delBtn.onclick = async ()=> { if(confirm('Delete this message?')) { await sb.from('messages').delete().eq('id', id); } };
        acts.append(editBtn, delBtn);
      }

      const replyBtn = document.createElement('button'); replyBtn.className='pill'; replyBtn.textContent='Reply'; replyBtn.onclick = ()=>{ replyingToMessageId = id; openReplyBar(username, text); messageInput.focus(); };
      acts.appendChild(replyBtn);

      // thumbs up/down
      const upBtn = document.createElement('button'); upBtn.className='pill'; upBtn.innerHTML = 'üëç <span>' + ((m.reactions && m.reactions.thumbsUp) || 0) + '</span>'; upBtn.onclick = ()=> react(id,'thumbsUp');
      const downBtn = document.createElement('button'); downBtn.className='pill'; downBtn.innerHTML = 'üëé <span>' + ((m.reactions && m.reactions.thumbsDown) || 0) + '</span>'; downBtn.onclick = ()=> react(id,'thumbsDown');
      acts.append(upBtn, downBtn);

      wrapper.append(av, content, acts);
      return wrapper;
    }

    function openEdit(node, m){
      const id = m.id; const content = node.querySelector('div:nth-child(2)'); const textEl = content.querySelector('.text');
      // hide text and insert edit area
      textEl.style.display='none';
      const editWrap = document.createElement('div'); editWrap.style.display='grid'; editWrap.style.gridTemplateColumns='1fr auto auto'; editWrap.style.gap='8px'; editWrap.style.marginTop='8px';
      const input = document.createElement('input'); input.className='text-input'; input.value = m.text || '';
      const save = document.createElement('button'); save.className='pill'; save.textContent='Save'; save.onclick = async ()=>{ const v = input.value.trim(); if(v){ await sb.from('messages').update({ text: v }).eq('id', id); } editWrap.remove(); textEl.style.display=''; };
      const cancel = document.createElement('button'); cancel.className='pill'; cancel.textContent='Cancel'; cancel.onclick = ()=>{ editWrap.remove(); textEl.style.display=''; };
      editWrap.append(input, save, cancel); content.appendChild(editWrap); input.focus();
    }

    async function react(id,type){
      try{ const { data } = await sb.from('messages').select('reactions').eq('id', id).single(); const current = data.reactions || { thumbsUp:0, thumbsDown:0 }; current[type] = (current[type]||0) + 1; await sb.from('messages').update({ reactions: current }).eq('id', id); }
      catch(e){console.error('react err',e)}
    }

    // ---------- LOAD & SUBSCRIBE ----------
    async function renderAll(){ chatArea.setAttribute('aria-busy','true'); chatArea.innerHTML=''; const { data, error } = await sb.from('messages').select('*').order('created_at',{ascending:true}); if(error){ chatArea.textContent='Could not load messages.'; console.error(error); return;} messagesMap.clear(); data.forEach(m=>messagesMap.set(m.id,m)); for(const m of data){ chatArea.appendChild(messageNode(m)); } chatArea.setAttribute('aria-busy','false'); scrollToBottom(); }

    function handleRealtime(payload){ const { eventType, new: newRecord, old: oldRecord, table } = payload; if(table!=='messages') return;
      if(eventType === 'INSERT'){ messagesMap.set(newRecord.id,newRecord); chatArea.appendChild(messageNode(newRecord)); scrollToBottom(); }
      if(eventType === 'UPDATE'){ const el = document.getElementById(`msg-${newRecord.id}`); messagesMap.set(newRecord.id,newRecord); if(el){ el.replaceWith(messageNode(newRecord)); } }
      if(eventType === 'DELETE'){ const node = document.getElementById(`msg-${oldRecord.id}`); if(node){ messagesMap.delete(oldRecord.id); node.remove(); } }
    }

    // init
    renderAll();
    sb.channel('public:messages')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, handleRealtime)
      .subscribe();

    // keyboard accessibility: focus composer on load
    window.addEventListener('load', ()=> { messageInput.focus(); });

    // expose a simple debug helper
    window.__chat = { renderAll };
  </script>
</body>
</html>
