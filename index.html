<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Free &amp; Complicated Messenger üòâ‚úåÔ∏è</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg: #f4f4f7;
      --bg-card: #ffffff;
      --bg-header: #ffffff;
      --bg-input: #f7f7fb;
      --text-main: #1f2933;
      --text-muted: #6b7280;
      --accent: #3b82f6;
      --accent-soft: rgba(59, 130, 246, 0.12);
      --border-subtle: #e5e7eb;
      --bubble-mine: #3b82f6;
      --bubble-their: #f3f4f6;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.12);
      --radius-lg: 18px;
      --radius-full: 999px;
      --transition-fast: 0.18s ease-out;
    }

    :root[data-theme="dark"] {
      --bg: #020617;
      --bg-card: #020617;
      --bg-header: #020617;
      --bg-input: #020617;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --accent: #60a5fa;
      --accent-soft: rgba(96, 165, 250, 0.12);
      --border-subtle: #1f2937;
      --bubble-mine: #2563eb;
      --bubble-their: #111827;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.75);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #1d4ed8 0, transparent 55%),
        radial-gradient(circle at bottom right, #a855f7 0, transparent 50%),
        var(--bg);
      color: var(--text-main);
    }

    .app-shell {
      width: 100%;
      max-width: 1040px;
      background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.12),
          rgba(148, 163, 184, 0.06)
        ),
        var(--bg-card);
      border-radius: 28px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.28);
      backdrop-filter: blur(26px);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 24px 14px;
      border-bottom: 1px solid var(--border-subtle);
      background: linear-gradient(
        135deg,
        rgba(15, 23, 42, 0.85),
        rgba(30, 64, 175, 0.85)
      );
      color: #f9fafb;
    }

    .header-main {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .title-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    h1 {
      font-size: 1.25rem;
      letter-spacing: 0.02em;
      font-weight: 650;
    }

    .tagline {
      font-size: 0.82rem;
      color: rgba(209, 213, 219, 0.9);
    }

    .chip {
      font-size: 0.7rem;
      padding: 3px 9px;
      border-radius: 999px;
      background: rgba(15, 118, 110, 0.85);
      color: #ecfeff;
      border: 1px solid rgba(34, 211, 238, 0.7);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.8rem;
    }

    .username-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.18);
      border: 1px solid rgba(148, 163, 184, 0.5);
      cursor: pointer;
    }

    .username-pill span:first-child {
      font-weight: 500;
    }

    .theme-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      padding: 4px 10px;
      background: rgba(15, 23, 42, 0.3);
      color: #e5e7eb;
      cursor: pointer;
      font-size: 0.8rem;
      transition: background var(--transition-fast),
        transform var(--transition-fast), box-shadow var(--transition-fast);
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.44);
    }

    .theme-toggle:hover {
      background: rgba(15, 23, 42, 0.6);
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(15, 23, 42, 0.8);
    }

    .theme-toggle-icon {
      font-size: 0.95rem;
    }

    main {
      padding: 12px 18px 14px;
      display: flex;
      gap: 12px;
      height: min(640px, calc(100vh - 140px));
    }

    .chat-card {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-radius: 20px;
      background: rgba(15, 23, 42, 0.02);
      border: 1px solid rgba(148, 163, 184, 0.55);
      position: relative;
      overflow: hidden;
    }

    .chat-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 12px 12px 10px;
      gap: 8px;
      overflow-y: auto;
      scroll-behavior: smooth;
    }

    .chat-body::-webkit-scrollbar {
      width: 8px;
    }
    .chat-body::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.7);
      border-radius: 999px;
    }

    .system-banner {
      align-self: center;
      font-size: 0.72rem;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.06);
      color: var(--text-muted);
      border: 1px solid rgba(148, 163, 184, 0.5);
      margin-bottom: 4px;
    }

    .message {
      display: flex;
      gap: 8px;
      margin-bottom: 6px;
      opacity: 0;
      transform: translateY(6px);
      animation: messageIn 0.22s ease-out forwards;
    }

    @keyframes messageIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.me {
      flex-direction: row-reverse;
    }

    .avatar {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.82rem;
      font-weight: 600;
      color: #f9fafb;
      flex-shrink: 0;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.4);
    }

    .bubble-wrapper {
      max-width: 75%;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .meta-row {
      display: flex;
      align-items: baseline;
      gap: 4px;
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .sender-name {
      font-weight: 550;
    }

    .timestamp {
      font-variant-numeric: tabular-nums;
      opacity: 0.9;
    }

    .reply-preview {
      font-size: 0.72rem;
      background: rgba(148, 163, 184, 0.14);
      border-left: 3px solid rgba(148, 163, 184, 0.9);
      border-radius: 10px;
      padding: 4px 8px;
      color: var(--text-muted);
      max-height: 48px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .bubble {
      border-radius: 16px;
      padding: 8px 11px;
      font-size: 0.86rem;
      line-height: 1.4;
      position: relative;
      border: 1px solid rgba(148, 163, 184, 0.55);
      background: var(--bubble-their);
      color: var(--text-main);
    }

    .message.me .bubble {
      background: linear-gradient(135deg, var(--bubble-mine), #4f46e5);
      color: #e5e7eb;
      border-color: rgba(191, 219, 254, 0.65);
    }

    .bubble-actions {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 4px;
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .bubble-actions button {
      border: none;
      background: transparent;
      padding: 2px 6px;
      border-radius: 999px;
      cursor: pointer;
      color: inherit;
      display: inline-flex;
      align-items: center;
      gap: 2px;
      transition: background var(--transition-fast), transform var(--transition-fast);
    }

    .bubble-actions button:hover {
      background: rgba(148, 163, 184, 0.22);
      transform: translateY(-1px);
    }

    .bubble-actions button.danger:hover {
      background: rgba(248, 113, 113, 0.15);
      color: #fca5a5;
    }

    .reactions {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: 3px;
      padding-left: 2px;
    }

    .reaction-pill {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 1px 6px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.14);
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .bubble-actions button.reaction-btn.active {
      background: rgba(34, 197, 94, 0.18);
      color: #4ade80;
    }
    .bubble-actions button.reaction-btn.down.active {
      background: rgba(248, 113, 113, 0.18);
      color: #fca5a5;
    }

    .composer-area {
      border-top: 1px solid rgba(148, 163, 184, 0.6);
      background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.08), transparent 45%),
        var(--bg-input);
      padding: 8px 10px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .reply-bar {
      display: none;
      align-items: center;
      justify-content: space-between;
      background: rgba(59, 130, 246, 0.12);
      border-radius: 12px;
      padding: 4px 8px;
      border: 1px dashed rgba(59, 130, 246, 0.65);
      font-size: 0.76rem;
      color: var(--text-muted);
    }

    .reply-bar span {
      max-width: 80%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .reply-bar button {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 0.78rem;
      color: rgba(248, 113, 113, 0.9);
    }

    .composer-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
    }

    textarea {
      flex: 1;
      resize: none;
      min-height: 42px;
      max-height: 120px;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 8px 11px;
      font-size: 0.86rem;
      background: rgba(15, 23, 42, 0.02);
      color: var(--text-main);
      outline: none;
      box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.08);
    }

    textarea::placeholder {
      color: rgba(148, 163, 184, 0.85);
    }

    textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.55);
    }

    .send-btn {
      border-radius: 999px;
      padding: 8px 16px;
      border: none;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #ecfdf3;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 550;
      box-shadow: 0 10px 24px rgba(22, 163, 74, 0.55);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast),
        opacity var(--transition-fast), background var(--transition-fast);
      flex-shrink: 0;
    }

    .send-btn span.icon {
      font-size: 0.95rem;
    }

    .send-btn:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
      transform: none;
      background: linear-gradient(135deg, #22c55e, #16a34a);
    }

    .send-btn:not(:disabled):hover {
      transform: translateY(-1px) translateX(0.5px);
      box-shadow: 0 14px 32px rgba(22, 163, 74, 0.8);
    }

    footer {
      padding: 6px 16px 9px;
      text-align: center;
      font-size: 0.8rem;
      color: rgba(148, 163, 184, 0.9);
    }

    @media (max-width: 768px) {
      .app-shell {
        border-radius: 18px;
      }
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      main {
        padding: 10px 10px 8px;
        height: calc(100vh - 160px);
      }
      .chat-body {
        padding: 10px 8px 8px;
      }
      .bubble-wrapper {
        max-width: 82%;
      }
      .title-row {
        flex-wrap: wrap;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 6px;
      }
      .app-shell {
        border-radius: 16px;
      }
      header {
        padding: 12px 14px;
      }
      main {
        padding: 8px 8px 6px;
      }
      .chat-body {
        padding: 8px 6px 6px;
      }
      .avatar {
        width: 30px;
        height: 30px;
        font-size: 0.74rem;
      }
      .send-btn {
        padding-inline: 12px;
      }
      .username-pill {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="header-main">
        <div class="title-row">
          <h1>Free &amp; Complicated Messenger üòâ‚úåÔ∏è</h1>
          <span class="chip">Realtime ‚Ä¢ Supabase</span>
        </div>
        <p class="tagline">
          A tiny but dramatic chat box with replies, edits, reactions &amp; themes.
        </p>
      </div>

      <div class="header-right">
        <div class="username-pill" id="username-pill" title="Click to change username">
          <span id="username-label">@anon</span>
          <span>‚úèÔ∏è</span>
        </div>

        <button class="theme-toggle" id="theme-toggle" type="button">
          <span class="theme-toggle-icon" id="theme-icon">üåô</span>
          <span id="theme-label">Dark</span>
        </button>
      </div>
    </header>

    <main>
      <section class="chat-card">
        <div class="chat-body" id="chat-body">
          <div class="system-banner" id="system-banner">
            Connecting to Supabase chat‚Ä¶
          </div>
        </div>

        <div class="composer-area">
          <div class="reply-bar" id="reply-bar">
            <span id="reply-preview-text"></span>
            <button id="cancel-reply-btn" type="button">cancel ‚úñ</button>
          </div>

          <div class="composer-row">
            <textarea
              id="message-input"
              rows="1"
              placeholder="Type something complicated‚Ä¶ (Shift+Enter for newline)"
            ></textarea>
            <button class="send-btn" id="send-btn" type="button" disabled>
              <span class="icon">‚û§</span>
              <span>Send</span>
            </button>
          </div>
        </div>
      </section>
    </main>

    <footer>
      made with ‚ù§Ô∏è‚òïÔ∏è
    </footer>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    const supabaseUrl = 'https://fzjkpppzwiuozvszbbdl.supabase.co';
    const supabaseKey =
      'sb_publishable_ClRXbub_U_y3zA3E9oFdUg_vyzDiPtN';
    const supabase = createClient(supabaseUrl, supabaseKey);

    const chatBody = document.getElementById('chat-body');
    const systemBanner = document.getElementById('system-banner');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const replyBar = document.getElementById('reply-bar');
    const replyPreviewText = document.getElementById('reply-preview-text');
    const cancelReplyBtn = document.getElementById('cancel-reply-btn');
    const usernamePill = document.getElementById('username-pill');
    const usernameLabel = document.getElementById('username-label');
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = document.getElementById('theme-icon');
    const themeLabel = document.getElementById('theme-label');

    let username = null;
    let currentReplyTo = null;
    let editingMessageId = null;
    const messagesCache = new Map();

    const THEME_KEY = 'fcm_theme';
    const USERNAME_KEY = 'fcm_username';

    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      if (theme === 'dark') {
        themeIcon.textContent = '‚òÄÔ∏è';
        themeLabel.textContent = 'Light';
      } else {
        themeIcon.textContent = 'üåô';
        themeLabel.textContent = 'Dark';
      }
      localStorage.setItem(THEME_KEY, theme);
    }

    (function initTheme() {
      const saved = localStorage.getItem(THEME_KEY) || 'light';
      applyTheme(saved);
    })();

    themeToggle.addEventListener('click', () => {
      const current = document.documentElement.getAttribute('data-theme') || 'light';
      applyTheme(current === 'light' ? 'dark' : 'light');
    });

    function randomColorFromName(name) {
      let hash = 0;
      for (let i = 0; i < name.length; i++) {
        hash = (hash << 5) - hash + name.charCodeAt(i);
        hash |= 0;
      }
      const hue = Math.abs(hash) % 360;
      return `hsl(${hue}, 72%, 52%)`;
    }

    function initialsFromName(name) {
      return name
        .split(' ')
        .map((n) => n[0])
        .join('')
        .toUpperCase()
        .slice(0, 2);
    }

    function ensureUsername() {
      let stored = localStorage.getItem(USERNAME_KEY);
      if (!stored) {
        stored = prompt('Choose a chat username (e.g. coffee_coder):') || 'anonymous';
        stored = stored.trim() || 'anonymous';
        localStorage.setItem(USERNAME_KEY, stored);
      }
      username = stored;
      usernameLabel.textContent = '@' + username;
    }

    usernamePill.addEventListener('click', () => {
      const next = prompt('Update your username:', username || 'anonymous');
      if (next && next.trim()) {
        username = next.trim();
        localStorage.setItem(USERNAME_KEY, username);
        usernameLabel.textContent = '@' + username;
      }
    });

    ensureUsername();

    messageInput.addEventListener('input', () => {
      sendBtn.disabled = !messageInput.value.trim();
    });

    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (!sendBtn.disabled) {
          handleSend();
        }
      }
    });

    cancelReplyBtn.addEventListener('click', () => {
      currentReplyTo = null;
      replyBar.style.display = 'none';
      replyPreviewText.textContent = '';
    });

    sendBtn.addEventListener('click', handleSend);

    async function handleSend() {
      const text = messageInput.value.trim();
      if (!text) return;

      if (editingMessageId) {
        const purpose = 'Update an existing message text (edit). Requires id and new text.';
        console.log('[Supabase] Operation:', purpose, {
          id: editingMessageId,
          text
        });

        const { data, error } = await supabase
          .from('messages')
          .update({ text })
          .eq('id', editingMessageId)
          .select()
          .single();

        if (error) {
          console.error('Failed to update message', error);
          alert('Could not update message. Check console for details.');
          return;
        }

        console.log('Message updated successfully', data);
        editingMessageId = null;
        messageInput.value = '';
        sendBtn.disabled = true;
        return;
      }

      const reactions = { up: 0, down: 0 };

      const purpose =
        'Insert a new message. Requires username, text, optional reply_to, and initial reactions JSON.';
      console.log('[Supabase] Operation:', purpose, {
        username,
        text,
        reply_to: currentReplyTo,
        reactions
      });

      const { data, error } = await supabase
        .from('messages')
        .insert({
          username,
          text,
          reply_to: currentReplyTo,
          reactions
        })
        .select()
        .single();

      if (error) {
        console.error('Failed to send message', error);
        alert('Could not send message. Check console for details.');
        return;
      }

      console.log('Message inserted successfully', data);
      messageInput.value = '';
      sendBtn.disabled = true;
      currentReplyTo = null;
      replyBar.style.display = 'none';
      replyPreviewText.textContent = '';
    }

    function formatTime(ts) {
      const d = new Date(ts);
      return d.toLocaleTimeString([], {
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function renderMessage(msg) {
      const isMine = msg.username === username;
      const existing = document.querySelector(`[data-message-id="${msg.id}"]`);
      if (existing) existing.remove();

      const wrap = document.createElement('div');
      wrap.className = 'message' + (isMine ? ' me' : '');
      wrap.dataset.messageId = msg.id;

      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.style.background = randomColorFromName(msg.username);
      avatar.textContent = initialsFromName(msg.username);

      const bubbleWrapper = document.createElement('div');
      bubbleWrapper.className = 'bubble-wrapper';

      const metaRow = document.createElement('div');
      metaRow.className = 'meta-row';
      const senderEl = document.createElement('span');
      senderEl.className = 'sender-name';
      senderEl.textContent = msg.username;
      const timeEl = document.createElement('span');
      timeEl.className = 'timestamp';
      timeEl.textContent = formatTime(msg.created_at);
      metaRow.append(senderEl, '¬∑', timeEl);

      if (msg.reply_to && messagesCache.has(msg.reply_to)) {
        const parent = messagesCache.get(msg.reply_to);
        const replyPreview = document.createElement('div');
        replyPreview.className = 'reply-preview';
        replyPreview.textContent = `${parent.username}: ${parent.text}`;
        bubbleWrapper.appendChild(replyPreview);
      }

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = msg.text;

      const actions = document.createElement('div');
      actions.className = 'bubble-actions';

      const replyBtn = document.createElement('button');
      replyBtn.textContent = '‚Ü© Reply';
      replyBtn.addEventListener('click', () => {
        currentReplyTo = msg.id;
        replyBar.style.display = 'flex';
        replyPreviewText.textContent = `${msg.username}: ${msg.text}`;
        messageInput.focus();
      });
      actions.appendChild(replyBtn);

      if (isMine) {
        const editBtn = document.createElement('button');
        editBtn.textContent = '‚úè Edit';
        editBtn.addEventListener('click', () => {
          editingMessageId = msg.id;
          messageInput.value = msg.text;
          messageInput.focus();
          sendBtn.disabled = !messageInput.value.trim();
        });
        actions.appendChild(editBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'üóë Delete';
        deleteBtn.classList.add('danger');
        deleteBtn.addEventListener('click', async () => {
          if (!confirm('Delete this message for everyone?')) return;

          const purpose =
            'Delete a message by id. Requires id to target row.';
          console.log('[Supabase] Operation:', purpose, { id: msg.id });

          const { error } = await supabase
            .from('messages')
            .delete()
            .eq('id', msg.id);

          if (error) {
            console.error('Failed to delete message', error);
            alert('Could not delete message. Check console for details.');
            return;
          }
          console.log('Message deleted successfully');
        });
        actions.appendChild(deleteBtn);
      }

      const upBtn = document.createElement('button');
      upBtn.classList.add('reaction-btn');
      upBtn.innerHTML = 'üëç <span class="count"></span>';
      const downBtn = document.createElement('button');
      downBtn.classList.add('reaction-btn', 'down');
      downBtn.innerHTML = 'üëé <span class="count"></span>';

      const reactionsBox = document.createElement('div');
      reactionsBox.className = 'reactions';

      function applyReactions(r) {
        const upCount = (r && r.up) || 0;
        const downCount = (r && r.down) || 0;
        upBtn.querySelector('.count').textContent = upCount || '';
        downBtn.querySelector('.count').textContent = downCount || '';
        reactionsBox.innerHTML = '';
        if (upCount > 0) {
          const pill = document.createElement('span');
          pill.className = 'reaction-pill';
          pill.textContent = `üëç ${upCount}`;
          reactionsBox.appendChild(pill);
        }
        if (downCount > 0) {
          const pill = document.createElement('span');
          pill.className = 'reaction-pill';
          pill.textContent = `üëé ${downCount}`;
          reactionsBox.appendChild(pill);
        }
      }

      async function updateReaction(deltaUp, deltaDown) {
        const purpose =
          'Update reactions JSON for a message. Requires id and partial reactions delta.';
        console.log('[Supabase] Operation:', purpose, {
          id: msg.id,
          deltaUp,
          deltaDown
        });

        const currentReactions = msg.reactions || { up: 0, down: 0 };
        const newReactions = {
          up: Math.max(0, (currentReactions.up || 0) + deltaUp),
          down: Math.max(0, (currentReactions.down || 0) + deltaDown)
        };

        const { data, error } = await supabase
          .from('messages')
          .update({ reactions: newReactions })
          .eq('id', msg.id)
          .select()
          .single();

        if (error) {
          console.error('Failed to update reactions', error);
          alert('Could not update reactions. Check console for details.');
          return;
        }
        console.log('Reactions updated successfully', data);
      }

      upBtn.addEventListener('click', () => {
        const current = msg.reactions || { up: 0, down: 0 };
        updateReaction(1, 0);
        msg.reactions = {
          ...current,
          up: (current.up || 0) + 1
        };
        applyReactions(msg.reactions);
      });

      downBtn.addEventListener('click', () => {
        const current = msg.reactions || { up: 0, down: 0 };
        updateReaction(0, 1);
        msg.reactions = {
          ...current,
          down: (current.down || 0) + 1
        };
        applyReactions(msg.reactions);
      });

      actions.appendChild(upBtn);
      actions.appendChild(downBtn);

      applyReactions(msg.reactions || { up: 0, down: 0 });

      bubbleWrapper.append(metaRow, bubble, actions, reactionsBox);

      wrap.append(avatar, bubbleWrapper);

      const existingNodes = Array.from(
        chatBody.querySelectorAll('.message')
      );
      const insertIndex = existingNodes.findIndex((n) => {
        const id = Number(n.dataset.messageId);
        return msg.id < id;
      });
      if (insertIndex === -1) {
        chatBody.appendChild(wrap);
      } else {
        chatBody.insertBefore(wrap, existingNodes[insertIndex]);
      }

      requestAnimationFrame(() => {
        chatBody.scrollTop = chatBody.scrollHeight;
      });
    }

    function removeMessage(id) {
      messagesCache.delete(id);
      const el = document.querySelector(`[data-message-id="${id}"]`);
      if (el) el.remove();
    }

    async function loadInitialMessages() {
      systemBanner.textContent = 'Loading messages‚Ä¶';

      const { data, error } = await supabase
        .from('messages')
        .select('*')
        .order('created_at', { ascending: true })
        .limit(200);

      if (error) {
        console.error('Error loading messages', error);
        systemBanner.textContent = 'Could not load messages üò¢';
        return;
      }

      systemBanner.textContent = 'You are live. Say hi üëã';
      chatBody.removeChild(systemBanner);

      data.forEach((msg) => {
        messagesCache.set(msg.id, msg);
      });

      data.forEach(renderMessage);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function setupRealtime() {
      const channel = supabase
        .channel('realtime-messages')
        .on(
          'postgres_changes',
          { event: 'INSERT', schema: 'public', table: 'messages' },
          (payload) => {
            const msg = payload.new;
            messagesCache.set(msg.id, msg);
            renderMessage(msg);
          }
        )
        .on(
          'postgres_changes',
          { event: 'UPDATE', schema: 'public', table: 'messages' },
          (payload) => {
            const msg = payload.new;
            messagesCache.set(msg.id, msg);
            renderMessage(msg);
          }
        )
        .on(
          'postgres_changes',
          { event: 'DELETE', schema: 'public', table: 'messages' },
          (payload) => {
            removeMessage(payload.old.id);
          }
        )
        .subscribe((status) => {
          console.log('Realtime status:', status);
        });
    }

    loadInitialMessages();
    setupRealtime();
  </script>
</body>
</html>
